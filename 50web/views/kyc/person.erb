<%
# some nicer view helpers
countries = [{code:'US',name:'United States'},{code:'AF',name:'Afghanistan'},{code:'AX',name:'Åland Islands'},{code:'AL',name:'Albania'},{code:'DZ',name:'Algeria'},{code:'AS',name:'American Samoa'},{code:'AD',name:'Andorra'},{code:'AO',name:'Angola'},{code:'AI',name:'Anguilla'},{code:'AG',name:'Antigua and Barbuda'},{code:'AR',name:'Argentina'},{code:'AM',name:'Armenia'},{code:'AW',name:'Aruba'},{code:'AU',name:'Australia'},{code:'AT',name:'Austria'},{code:'AZ',name:'Azerbaijan'},{code:'BS',name:'Bahamas'},{code:'BH',name:'Bahrain'},{code:'BD',name:'Bangladesh'},{code:'BB',name:'Barbados'},{code:'BY',name:'Belarus'},{code:'BE',name:'Belgium'},{code:'BZ',name:'Belize'},{code:'BJ',name:'Benin'},{code:'BM',name:'Bermuda'},{code:'BT',name:'Bhutan'},{code:'BO',name:'Bolivia'},{code:'BA',name:'Bosnia and Herzegovina'},{code:'BW',name:'Botswana'},{code:'BR',name:'Brazil'},{code:'IO',name:'British Indian Ocean'},{code:'BN',name:'Brunei Darussalam'},{code:'BG',name:'Bulgaria'},{code:'BF',name:'Burkina Faso'},{code:'BI',name:'Burundi'},{code:'KH',name:'Cambodia'},{code:'CM',name:'Cameroon'},{code:'CA',name:'Canada'},{code:'CV',name:'Cape Verde'},{code:'KY',name:'Cayman Islands'},{code:'CF',name:'Central African Republic'},{code:'TD',name:'Chad'},{code:'CL',name:'Chile'},{code:'CN',name:'China'},{code:'CX',name:'Christmas Island'},{code:'CC',name:'Cocos Islands'},{code:'CO',name:'Colombia'},{code:'KM',name:'Comoros'},{code:'CG',name:'Congo'},{code:'CD',name:'Congo, Democratic Republic'},{code:'CK',name:'Cook Islands'},{code:'CR',name:'Costa Rica'},{code:'CI',name:'Côte d’Ivoire'},{code:'HR',name:'Croatia'},{code:'CU',name:'Cuba'},{code:'CW',name:'Curaçao'},{code:'CY',name:'Cyprus'},{code:'CZ',name:'Czech Republic'},{code:'DK',name:'Denmark'},{code:'DJ',name:'Djibouti'},{code:'DM',name:'Dominica'},{code:'DO',name:'Dominican Republic'},{code:'EC',name:'Ecuador'},{code:'EG',name:'Egypt'},{code:'SV',name:'El Salvador'},{code:'GQ',name:'Equatorial Guinea'},{code:'ER',name:'Eritrea'},{code:'EE',name:'Estonia'},{code:'ET',name:'Ethiopia'},{code:'FK',name:'Falkland Islands'},{code:'FO',name:'Faroe Islands'},{code:'FJ',name:'Fiji'},{code:'FI',name:'Finland'},{code:'FR',name:'France'},{code:'GF',name:'French Guiana'},{code:'PF',name:'French Polynesia'},{code:'GA',name:'Gabon'},{code:'GM',name:'Gambia'},{code:'GE',name:'Georgia'},{code:'DE',name:'Germany'},{code:'GH',name:'Ghana'},{code:'GI',name:'Gibraltar'},{code:'GR',name:'Greece'},{code:'GL',name:'Greenland'},{code:'GD',name:'Grenada'},{code:'GP',name:'Guadeloupe'},{code:'GU',name:'Guam'},{code:'GT',name:'Guatemala'},{code:'GG',name:'Guernsey'},{code:'GN',name:'Guinea'},{code:'GW',name:'Guinea-Bissau'},{code:'GY',name:'Guyana'},{code:'HT',name:'Haiti'},{code:'HN',name:'Honduras'},{code:'HK',name:'Hong Kong'},{code:'HU',name:'Hungary'},{code:'IS',name:'Iceland'},{code:'IN',name:'India'},{code:'ID',name:'Indonesia'},{code:'IR',name:'Iran'},{code:'IQ',name:'Iraq'},{code:'IE',name:'Ireland'},{code:'IM',name:'Isle of Man'},{code:'IL',name:'Israel'},{code:'IT',name:'Italy'},{code:'JM',name:'Jamaica'},{code:'JP',name:'Japan'},{code:'JE',name:'Jersey'},{code:'JO',name:'Jordan'},{code:'KZ',name:'Kazakhstan'},{code:'KE',name:'Kenya'},{code:'KI',name:'Kiribati'},{code:'KP',name:'Korea, North'},{code:'KR',name:'Korea, South'},{code:'KW',name:'Kuwait'},{code:'KG',name:'Kyrgyzstan'},{code:'LA',name:'Laos'},{code:'LV',name:'Latvia'},{code:'LB',name:'Lebanon'},{code:'LS',name:'Lesotho'},{code:'LR',name:'Liberia'},{code:'LY',name:'Libyan Arab Jamahiriya'},{code:'LI',name:'Liechtenstein'},{code:'LT',name:'Lithuania'},{code:'LU',name:'Luxembourg'},{code:'MO',name:'Macao'},{code:'MK',name:'Macedonia'},{code:'MG',name:'Madagascar'},{code:'MW',name:'Malawi'},{code:'MY',name:'Malaysia'},{code:'MV',name:'Maldives'},{code:'ML',name:'Mali'},{code:'MT',name:'Malta'},{code:'MH',name:'Marshall Islands'},{code:'MQ',name:'Martinique'},{code:'MR',name:'Mauritania'},{code:'MU',name:'Mauritius'},{code:'YT',name:'Mayotte'},{code:'MX',name:'Mexico'},{code:'FM',name:'Micronesia'},{code:'MD',name:'Moldova, Republic of'},{code:'MC',name:'Monaco'},{code:'MN',name:'Mongolia'},{code:'ME',name:'Montenegro'},{code:'MS',name:'Montserrat'},{code:'MA',name:'Morocco'},{code:'MZ',name:'Mozambique'},{code:'MM',name:'Myanmar'},{code:'NA',name:'Namibia'},{code:'NR',name:'Nauru'},{code:'NP',name:'Nepal'},{code:'NL',name:'Netherlands'},{code:'AN',name:'Netherlands Antilles'},{code:'NC',name:'New Caledonia'},{code:'NZ',name:'New Zealand'},{code:'NI',name:'Nicaragua'},{code:'NE',name:'Niger'},{code:'NG',name:'Nigeria'},{code:'NU',name:'Niue'},{code:'NF',name:'Norfolk Island'},{code:'MP',name:'Northern Mariana Islands'},{code:'NO',name:'Norway'},{code:'OM',name:'Oman'},{code:'PK',name:'Pakistan'},{code:'PW',name:'Palau'},{code:'PS',name:'Palestinian Territory'},{code:'PA',name:'Panama'},{code:'PG',name:'Papua New Guinea'},{code:'PY',name:'Paraguay'},{code:'PE',name:'Peru'},{code:'PH',name:'Philippines'},{code:'PN',name:'Pitcairn'},{code:'PL',name:'Poland'},{code:'PT',name:'Portugal'},{code:'PR',name:'Puerto Rico'},{code:'QA',name:'Qatar'},{code:'RE',name:'Réunion'},{code:'RO',name:'Romania'},{code:'RU',name:'Russian Federation'},{code:'RW',name:'Rwanda'},{code:'BL',name:'Saint Barthélemy'},{code:'SH',name:'Saint Helena'},{code:'KN',name:'Saint Kitts and Nevis'},{code:'LC',name:'Saint Lucia'},{code:'MF',name:'Saint Martin (French)'},{code:'PM',name:'Saint Pierre and Miquelon'},{code:'VC',name:'Saint Vincent / Grenadines'},{code:'WS',name:'Samoa'},{code:'SM',name:'San Marino'},{code:'ST',name:'Sao Tome and Principe'},{code:'SA',name:'Saudi Arabia'},{code:'SN',name:'Senegal'},{code:'RS',name:'Serbia'},{code:'SC',name:'Seychelles'},{code:'SL',name:'Sierra Leone'},{code:'SG',name:'Singapore'},{code:'SX',name:'Sint Maarten (Dutch)'},{code:'SK',name:'Slovakia'},{code:'SI',name:'Slovenia'},{code:'SB',name:'Solomon Islands'},{code:'SO',name:'Somalia'},{code:'ZA',name:'South Africa'},{code:'SS',name:'South Sudan'},{code:'ES',name:'Spain'},{code:'LK',name:'Sri Lanka'},{code:'SD',name:'Sudan'},{code:'SR',name:'Suriname'},{code:'SZ',name:'Swaziland'},{code:'SE',name:'Sweden'},{code:'CH',name:'Switzerland'},{code:'SY',name:'Syrian Arab Republic'},{code:'TW',name:'Taiwan'},{code:'TJ',name:'Tajikistan'},{code:'TZ',name:'Tanzania'},{code:'TH',name:'Thailand'},{code:'TL',name:'Timor-Leste'},{code:'TG',name:'Togo'},{code:'TK',name:'Tokelau'},{code:'TO',name:'Tonga'},{code:'TT',name:'Trinidad and Tobago'},{code:'TN',name:'Tunisia'},{code:'TR',name:'Turkey'},{code:'TM',name:'Turkmenistan'},{code:'TC',name:'Turks and Caicos Islands'},{code:'TV',name:'Tuvalu'},{code:'UG',name:'Uganda'},{code:'UA',name:'Ukraine'},{code:'AE',name:'United Arab Emirates'},{code:'GB',name:'United Kingdom'},{code:'US',name:'United States'},{code:'UY',name:'Uruguay'},{code:'UZ',name:'Uzbekistan'},{code:'VU',name:'Vanuatu'},{code:'VE',name:'Venezuela'},{code:'VN',name:'Vietnam'},{code:'VG',name:'Virgin Islands, British'},{code:'VI',name:'Virgin Islands, U.S.'},{code:'WF',name:'Wallis and Futuna'},{code:'EH',name:'Western Sahara'},{code:'YE',name:'Yemen'},{code:'ZM',name:'Zambia'},{code:'ZW',name:'Zimbabwe'}]
o = countries.inject('<option value="">… country …</option>') do |html, pair|
	html + '<option value="%s"%s>%s</option>' % [pair[:code],
		(@person[:country] == pair[:code]) ? ' selected' : '',
		pair[:name][0,20]]
end

cleanstate = String(@person[:state]).strip.gsub(/[^A-Z a-z]/, '')
%>
<script>
function activate(form) {
	var url = form.getAttribute('data-post');
	// use window[functionName] to get function from string
	var after = window[form.getAttribute('data-after')];
	var postit = function(e) {
		e.preventDefault();
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function() {
			if(xhr.readyState == 4) {
				console.log(xhr.responseText);
				after(JSON.parse(xhr.responseText));
				form.reset();
			}
		};
	xhr.open('post', url, true);
	xhr.send(new FormData(form));
	};
	form.elements['submit'].addEventListener('click', postit, false);
}

function activateForms(node) {
	if(node.nodeName == 'FORM' && node.getAttribute('data-post')) {
		activate(node);
	} else {
		var l = node.children.length;
		for(var i=0; i < l; i++) {
			activateForms(node.children[i]);
		}
	}
}
</script>

<% if @email && @clash %>
	<form action="/person/<%= @person[:id] %>/match/<%= @email[:id] %>" method="post">
		<input type="submit" value="match email" style="color: #fff; background-color: #900; font-size: 1.2em;">
	</form>
<% end %>
<form id="personeditform" data-id="<%= @person[:id] %>" action="/person/<%= @person[:id] %>" method="post">
id: <a href="/person/<%= @person[:id] %>"><%= @person[:id] %></a>
 ☀ <%= @person[:created_at] %>
<input name="name" placeholder="name" value="<%=h @person[:name] %>">
<input type="email" name="email" placeholder="email" value="<%=h @person[:email] %>">
<input name="address" placeholder="address" value="<%=h @person[:address] %>">
<input name="company" placeholder="company" value="<%=h @person[:company] %>">
<fieldset>
<div id="maybe-flag" style="float:right"></div>
<select id="country" name="country"><%= o %></select>
<input id="city" placeholder="city" name="city" value="<%=h @person[:city] %>">
<div id="maybe-state"></div>
</fieldset>
<input name="categorize_as" placeholder="categorize_as" value="<%=h @person[:categorize_as] %>">
<input name="listype" placeholder="listype" value="<%= @person[:listype] %>">
<textarea name="notes" placeholder="notes"><%=h @person[:notes] %></textarea>
<% if @email %>
	<input type="hidden" name="email_id" value="<%= @email[:id] %>">
<% end %>
<input type="submit" value="update">
</form>
<script>
function flag_for(country) {
	var el = document.getElementById('maybe-flag');
	if(/^[A-Z]{2}$/.test(country)) {
		el.innerHTML = '<img src="/images/flags/' + country + '.png">';
	} else {
		el.innerHTML = '<img src="/images/flags/XX.png">';
	}
}

function states_for(country, state) {
	var countries = {
	'AU':[{code:'NSW',name:'New South Wales'},{code:'NT',name:'Northern Territory'},{code:'Qld',name:'Queensland'},{code:'SA',name:'South Australia'},{code:'Tas',name:'Tasmania'},{code:'Vic',name:'Victoria'},{code:'WA',name:'Western Australia'},{code:'ACT',name:'ACT'}],
	'CA':[{code:'AB',name:'Alberta'},{code:'BC',name:'British Columbia'},{code:'MB',name:'Manitoba'},{code:'NB',name:'New Brunswick'},{code:'NL',name:'Newfoundland/Labrador'},{code:'NT',name:'Northwest Territories'},{code:'NS',name:'Nova Scotia'},{code:'NU',name:'Nunavut'},{code:'ON',name:'Ontario'},{code:'PE',name:'Prince Edward Island'},{code:'QC',name:'Quebec'},{code:'SK',name:'Saskatchewan'},{code:'YT',name:'Yukon Territory'}],
	'US':[{code:'AL',name:'Alabama'},{code:'AK',name:'Alaska'},{code:'AZ',name:'Arizona'},{code:'AR',name:'Arkansas'},{code:'CA',name:'California'},{code:'CO',name:'Colorado'},{code:'CT',name:'Connecticut'},{code:'DE',name:'Delaware'},{code:'DC',name:'D.C.'},{code:'FL',name:'Florida'},{code:'GA',name:'Georgia'},{code:'HI',name:'Hawaii'},{code:'ID',name:'Idaho'},{code:'IL',name:'Illinois'},{code:'IN',name:'Indiana'},{code:'IA',name:'Iowa'},{code:'KS',name:'Kansas'},{code:'KY',name:'Kentucky'},{code:'LA',name:'Louisiana'},{code:'ME',name:'Maine'},{code:'MD',name:'Maryland'},{code:'MA',name:'Massachusetts'},{code:'MI',name:'Michigan'},{code:'MN',name:'Minnesota'},{code:'MS',name:'Mississippi'},{code:'MO',name:'Missouri'},{code:'MT',name:'Montana'},{code:'NE',name:'Nebraska'},{code:'NV',name:'Nevada'},{code:'NH',name:'New Hampshire'},{code:'NJ',name:'New Jersey'},{code:'NM',name:'New Mexico'},{code:'NY',name:'New York'},{code:'NC',name:'North Carolina'},{code:'ND',name:'North Dakota'},{code:'OH',name:'Ohio'},{code:'OK',name:'Oklahoma'},{code:'OR',name:'Oregon'},{code:'PA',name:'Pennsylvania'},{code:'RI',name:'Rhode Island'},{code:'SC',name:'South Carolina'},{code:'SD',name:'South Dakota'},{code:'TN',name:'Tennessee'},{code:'TX',name:'Texas'},{code:'UT',name:'Utah'},{code:'VT',name:'Vermont'},{code:'VA',name:'Virginia'},{code:'WA',name:'Washington'},{code:'WV',name:'West Virginia'},{code:'WI',name:'Wisconsin'},{code:'WY',name:'Wyoming'}]};
	var el = document.getElementById('maybe-state');
	if(countries[country]) {
		var html = '<select id="state" name="state"><option value=""> … </option>';
		var cc=countries[country], l=cc.length, selected='';
		for(var i=0; i < l; i++) {
			selected = (cc[i]['code'] == state) ? ' selected="selected"' : '';
			html += '<option value="' + cc[i]['code'] + '"' + selected + '>';
			html += cc[i]['name'] + '</option>';
		}
		html += '</select>';
		el.innerHTML = html;
	} else {
		var html = '<input placeholder="state" name="state" value="' + state + '">';
		el.innerHTML = html;
	}
}

flag_for('<%= @person[:country]%>');
states_for('<%= @person[:country]%>', '<%= cleanstate %>');

function countryChanged(event) {
	flag_for(this.value);
	states_for(this.value, '<%= cleanstate %>');
}
document.getElementById('country').onchange = countryChanged;
</script>

<% if @tables %>
	<p>✿ <%= @tables.join(', ') %></p>
<% end %>

<div id="urls">
<h4>urls: (<a href="/now/<%= @person[:id] %>">now</a>)</h4>
<form id="urladd" data-post="/person/<%= @person[:id] %>/url.json" data-after="addUrl">
	<input name="url" placeholder="url" accesskey="u">
	<input id="urladdbutton" type="submit" name="submit" value="add url">
</form>
<ul id="urllist"></ul>
<script>
activate(document.getElementById('urladd'));

function formUrl(u) {
	return('<form data-post="/url/' + u.id + '/delete.json" data-after="killUrl">' +
	'<input type="submit" name="submit" value="x"></form>' +
	'<form data-post="/url/' + u.id + '.json" data-after="updateUrl">' +
	'<input type="hidden" name="star" value="' + (u.main ? 'f' : 't') + '">' +
	'<input type="submit" name="submit" value="' + (u.main ? '★' : '☆') + '">' +
	'<a href="/link?url=' + encodeURIComponent(u.url) + '">' + u.url.replace(/^https?:\/\//, '') + '</a></form>');
}
function listUrl(u) {
	var li = document.createElement('li');
	li.id = 'url-' + u.id;
	li.innerHTML = formUrl(u);
	var list = document.getElementById('urllist');
	list.appendChild(li);
	return li;
}
function addUrl(u) {
	var li = listUrl(u);
	activateForms(li);
}
function updateUrl(u) {
	var li = document.getElementById('url-' + u.id);
	li.innerHTML = formUrl(u);
	activateForms(li);
}
function killUrl(u) {
	var li = document.getElementById('url-' + u.id);
	document.getElementById('urllist').removeChild(li);
}

<% if @person[:urls] %>
	<% @person[:urls].each do |url| %>
		addUrl(<%= url.to_json %>);
	<% end %>
<% end %>
</script>
</div>

<div id="stats">
<h4>stats:</h4>
<form id="statadd" data-post="/person/<%= @person[:id] %>/stat.json" data-after="addStat">
	<input name="key" placeholder="key">
	<input name="value" placeholder="value">
	<input id="stataddbutton" type="submit" name="submit" value="add stat">
</form>
<ul id="statlist"></ul>
<script>
activate(document.getElementById('statadd'));

function listStat(s) {
	var li = document.createElement('li');
	li.id = 'stat-' + s.id;
	li.innerHTML = '<form data-post="/stat/' + s.id + '/delete.json" data-after="killStat">' +
		'<input type="submit" name="submit" value="x"></form>' +
		s.created_at.substring(0,10) + ' ' +
		s.name + ': ' +
		s.value;  // TODO: html escape
	var list = document.getElementById('statlist');
	list.appendChild(li);
	return li;
}
function addStat(s) {
	var li = listStat(s);
	activateForms(li);
}
function killStat(s) {
	var li = document.getElementById('stat-' + s.id);
	document.getElementById('statlist').removeChild(li);
}

<% if @person[:stats] %>
	<% @person[:stats].each do |stat| %>
		addStat(<%= stat.to_json %>);
	<% end %>
<% end %>
</script>
</div>

