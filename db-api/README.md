# db-api

My PostgreSQL database.  Â© 2016 50pop LLC | Contact: [Derek Sivers](http://sivers.org/)

One central database, called d50b, with each of my different projects in its own schema.

For some explanation, see <https://sivers.org/pg>

## The schemas:

* **core** : tables and functions shared by other schemas: currencies and translations
* **peeps** : people, emails, api keys. people table shared by all other schemas
* **sivers** : sivers.org blog comments
* **lat** : lateral thinking concepts (might remove from d50b, make local-only)
* **muckwork** : muckwork.com
* **musicthoughts** : musicthoughts.com
* **now** : nownownow.com
* **woodegg** : book research data, shared at data.woodegg.com
* **words** : translations and translators

## In each schema directory:

* **api.sql** : main public functions, each returning status & JSON
* **fixtures.sh** : shell script to output fixtures.sql
* **fixtures.sql** : dump of values for testing, to be loaded with each test
* **functions.sql** : any other functions, not API
* **README.md** : read me
* **schema.m4** : with each change to any .sql files, run **m4 schema.m4 > schema.sql**
* **schema.sql** : don't edit! auto generated by schema.m4
* **tables.sql** : create table
* **test-api.rb** : tests for api.sql functions
* **test-db.rb** : tests for non-API functions, like constraints, triggers, and functions
* **triggers.sql** : triggers
* **views.sql** : views used for complex JSON responses

## What's this other stuff?

* **script/** directory of scripts. set shell $PATH to add this
* **lib/** directory of require includes. symlink into $: Ruby path.
* **defs.m4** m4 macros used by schema.m4 in each schema directory
* **test_tools.rb** testing tools used by each schema directory


# Authentication / Login:

On 2016-10-05, I overhauled authentication to simplify to this:

* site first checks for "ok" cookie, lookup in peeps.logins, if not, does this:
* email + password form post gets person id
* another table allows them to be in this area or not
* examples: peeps.emailers, muckwork.clients, woodegg.customers
* sometimes they can add themselves to this table, like muckwork.clients, but usually not
* if they are also in that other necessary table, create entry in peeps.logins, and set "ok" cookie
* peeps.logins has personid, so if that changes, due to merge or whatever, table is updated


## Changes?

For small changes, just use psql to add a function, drop a table, etc.

The easiest way to make major changes is to copy the schema.sql files to /tmp/, then edit it to remove the "DROP SCHEMA" and "CREATE TABLE" lines.  All functions, triggers, and views can be replaced.

When adding a new schema, run this:

ALTER USER d50b SET SEARCH_PATH TO core, peeps, words, muckwork, lat, now, musicthoughts, sivers, woodegg;

# See also:

For some experiments, see <https://github.com/sivers/pg/>

For the websites that use these, see <http://code.50pop.com/50web/>

